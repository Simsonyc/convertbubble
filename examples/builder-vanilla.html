<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ConvertBubble — Builder Live NeuroBreak™ V3.0</title>

  <style>
    :root {
      --primary: linear-gradient(90deg, #ff7a18 0%, #00e0ff 100%);
      --bg: #0b0c14;
      --panel: #11131f;
      --text: #ffffff;
      --border: #1e2230;
      --input-bg: #0f111b;
      --shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
      --radius: 16px;
      --transition: all 0.25s ease;
    }

    [data-theme="light"] {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --text: #11131f;
      --border: #dfe3ee;
      --input-bg: #f3f4f7;
      --shadow: 0 4px 14px rgba(0, 0, 0, 0.08);
    }

    body {
      font-family: "Poppins", "Inter", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: var(--transition);
    }

    header {
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    header h1 {
      font-size: 16px;
      margin: 0;
      font-weight: 600;
      background: var(--primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .theme-toggle {
      background: var(--primary);
      border: none;
      border-radius: 50%;
      width: 38px;
      height: 38px;
      cursor: pointer;
      color: #fff;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
      transition: transform 0.3s ease;
    }
    .theme-toggle:hover { transform: scale(1.1); }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
    }

    section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: var(--shadow);
    }

    h3 {
      margin: 0 0 6px 0;
      font-size: 15px;
      font-weight: 600;
      background: var(--primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 14px;
    }

    input, select {
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: var(--transition);
    }

    input:focus, select:focus {
      border-color: #00e0ff;
      box-shadow: 0 0 6px rgba(0, 224, 255, 0.5);
    }

    button {
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid transparent;
      font-weight: 600;
      cursor: pointer;
      color: var(--text);
      background: #14151f;
      transition: all 0.25s ease;
    }

    button:hover {
      border-image: var(--primary) 1;
      border-width: 1px;
      background: #1c1e2b;
      color: #fff;
      box-shadow: 0 0 8px rgba(0, 224, 255, 0.4);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    button#addCTA,
    button#resetCTA,
    button#open,
    button#close,
    button#download,
    button#snippet {
      background: var(--primary);
      color: #fff;
      border: none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    iframe {
      width: 100%;
      border: none;
      border-radius: var(--radius);
      aspect-ratio: 16/9;
      background: rgba(0, 0, 0, 0.4);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px) saturate(130%);
      -webkit-backdrop-filter: blur(8px) saturate(130%);
      transition: all 0.3s ease;
    }

    @media (min-width: 768px) {
      main {
        flex-direction: row;
      }
      .builder-panel {
        flex: 1;
        max-width: 380px;
        overflow-y: auto;
        height: calc(100vh - 80px);
        padding-right: 4px;
      }
      .preview-panel {
        flex: 2;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      iframe {
        max-width: 640px;
      }
    }

    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-thumb {
      background: #00e0ff44;
      border-radius: 10px;
    }
  </style>
</head>

<body data-theme="dark">
  <header>
    <h1>ConvertBubble — Builder NeuroBreak™</h1>
    <button class="theme-toggle" id="themeToggle"> </button>
  </header>

  <main>
    <!-- === PANNEAU DE CONFIGURATION === -->
    <div class="builder-panel">

      <!-- Thème -->
      <section>
        <h3> Thème</h3>
        <label>Couleur primaire
          <input id="primary" type="color" value="#ff7a18">
        </label>
        <label>Forme
          <select id="shape">
            <option value="circle">Rond</option>
            <option value="rounded-rect">Rectangle arrondi</option>
          </select>
        </label>
        <label>Animation
          <select id="animation">
            <option value="none">Aucune</option>
            <option value="pulse">Pulse</option>
            <option value="bounce">Bounce</option>
          </select>
        </label>
      </section>

      <!-- Branding -->
      <section>
        <h3> Branding</h3>
        <label>Label
          <input id="brandLabel" type="text" placeholder="Ex : ConvertBubble">
        </label>
        <label>Couleur header
          <input id="brandColor" type="color" value="#00e0ff">
        </label>
      </section>

      <!-- Vidéo -->
      <section>
        <h3> Vidéo</h3>
        <label>URL vidéo
          <input id="videoUrl" type="url" placeholder="https://.../video.mp4">
        </label>
        <label>Image poster
          <input id="poster" type="url" placeholder="https://.../image.jpg">
        </label>
      </section>

      <!-- CTA -->
      <section>
        <h3> CTA</h3>
        <label>Texte du bouton
          <input id="ctaLabel" type="text" placeholder="Découvrir maintenant">
        </label>
        <label>Lien du bouton
          <input id="ctaHref" type="url" placeholder="https://boostandgrow.io">
        </label>
        <div class="btn-row">
          <button id="addCTA">Ajouter</button>
          <button id="resetCTA">Réinitialiser</button>
        </div>
      </section>

      <!-- Position -->
      <section>
        <h3> Position</h3>
        <div class="btn-row">
          <button data-pos="TL">TL</button>
          <button data-pos="TR">TR</button>
          <button data-pos="BL">BL</button>
          <button data-pos="BR">BR</button>
        </div>
      </section>

      <!-- Thèmes prédéfinis -->
      <section>
        <h3> Thèmes</h3>
        <div class="btn-row">
          <button data-theme-name="coach">Coach</button>
          <button data-theme-name="agency">Agence</button>
          <button data-theme-name="infopreneur">Infopreneur</button>
        </div>
      </section>

      <!-- Export -->
      <section>
        <h3> Export</h3>
        <div class="btn-row">
          <button id="open">Ouvrir</button>
          <button id="close">Fermer</button>
          <button id="download">Télécharger JSON</button>
          <button id="snippet">Copier Snippet</button>
          <button id="resetLocal" style="background:#ff4d4d;color:#fff;border:none;">
            Effacer sauvegarde locale
          </button>
        </div>
      </section>
    </div>

    <!-- === ZONE DE PRÉVISUALISATION === -->
    <div class="preview-panel">
      <iframe id="pv" src="../public/preview.html"></iframe>
    </div>
  </main>

  <!-- === SCRIPT BUILDER === -->
  <script src="../public/cb-builder.js"></script>
  <script>
    // Dark/Light toggle
    const toggle = document.getElementById("themeToggle");
    const body   = document.body;
    toggle.onclick = () => {
      const dark = body.getAttribute("data-theme") === "dark";
      body.setAttribute("data-theme", dark ? "light" : "dark");
      toggle.textContent = dark ? " " : " ";
    };

    (async function () {
      const iframe = document.getElementById("pv");
      await Builder.init({ iframe });

      const primary    = document.getElementById("primary");
      const shape      = document.getElementById("shape");
      const animation  = document.getElementById("animation");
      const brandLabel = document.getElementById("brandLabel");
      const brandColor = document.getElementById("brandColor");
      const videoUrl   = document.getElementById("videoUrl");
      const poster     = document.getElementById("poster");
      const ctaLabel   = document.getElementById("ctaLabel");
      const ctaHref    = document.getElementById("ctaHref");
      const addCTA     = document.getElementById("addCTA");
      const resetCTA   = document.getElementById("resetCTA");
      const btnOpen    = document.getElementById("open");
      const btnClose   = document.getElementById("close");
      const btnDownload= document.getElementById("download");
      const btnSnippet = document.getElementById("snippet");
      const btnResetLocal = document.getElementById("resetLocal");

      // THEME
      primary.addEventListener("input",  e => Builder.update({ theme: { primary: e.target.value }}));
      primary.addEventListener("change", e => Builder.update({ theme: { primary: e.target.value }}));

      shape.addEventListener("change", e =>
        Builder.update({ theme: { shape: e.target.value }})
      );

      animation.addEventListener("change", e =>
        Builder.update({ animation: e.target.value })
      );

      // BRANDING
      brandLabel.addEventListener("input", e =>
        Builder.update({ branding: { label: e.target.value, enabled: true }})
      );
      brandColor.addEventListener("input", e =>
        Builder.update({ branding: { color: e.target.value }})
      );

      // VIDEO
      videoUrl.addEventListener("change", e =>
        Builder.update({ video: { src: e.target.value }})
      );
      poster.addEventListener("change", e =>
        Builder.update({ video: { poster: e.target.value }})
      );

      // CTA
      let ctas = [];
      addCTA.addEventListener("click", () => {
        const label = ctaLabel.value.trim();
        const href  = ctaHref.value.trim();
        if (!label || !href) {
          alert("Complète le label et le lien du CTA");
          return;
        }
        ctas.push({ label, href });
        Builder.update({ ctas });
      });

      resetCTA.addEventListener("click", () => {
        ctas = [];
        Builder.update({ ctas: [] });
      });

      // POSITION
      document.querySelectorAll("[data-pos]").forEach(btn => {
        btn.addEventListener("click", () =>
          Builder.update({ position: btn.dataset.pos })
        );
      });

      // THEMES PREDEFINIS
      document.querySelectorAll("[data-theme-name]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const name = btn.dataset.themeName;
          try {
            const res  = await fetch(`../public/themes/${name}.json`);
            const data = await res.json();
            Builder.replace(data);
          } catch (e) {
            console.error("Erreur chargement thème", name, e);
            alert("Impossible de charger le thème " + name);
          }
        });
      });

      // EXPORT / OVERLAY
      btnOpen.addEventListener("click",  () => Builder.openOverlay());
      btnClose.addEventListener("click", () => Builder.closeOverlay());
      btnDownload.addEventListener("click", () => Builder.downloadJSON("config.json"));
      btnSnippet.addEventListener("click", async () => {
        const s = Builder.generateSnippet();
        await navigator.clipboard.writeText(s);
        alert("Snippet copié ");
      });

      // RESET LOCAL
      btnResetLocal.addEventListener("click", () => {
        if (confirm("Effacer la configuration locale ? Cette action est irréversible.")) {
          Builder.resetLocal();
          alert("Sauvegarde locale effacée ");
          location.reload();
        }
      });

      // INITIAL PUSH
      if (primary.value) Builder.update({ theme: { primary: primary.value }});
    })();
  </script>
</body>
</html> et cb.js : (function () {
  console.log(" cb.js initialisé (overlay CTA actif)");

  // ==========================================================
  // UTILITAIRES DE BASE
  // ==========================================================
  function el(tag, style) {
    const e = document.createElement(tag);
    if (style) Object.assign(e.style, style);
    return e;
  }
  function px(n) { return typeof n === "number" ? n + "px" : n; }

  // Convertit couleur → rgba()
  function toRgba(color, alpha = 1) {
    alpha = Math.max(0, Math.min(1, alpha));
    if (!color) return `rgba(255,0,85,${alpha})`;
    if (color.startsWith("rgba(")) {
      const parts = color.slice(5, -1).split(",").map(s => s.trim());
      if (parts.length === 4) parts[3] = String(alpha); else parts.push(String(alpha));
      return `rgba(${parts.join(",")})`;
    }
    if (color.startsWith("rgb(")) {
      const body = color.slice(4, -1);
      return `rgba(${body}, ${alpha})`;
    }
    const hex = color.replace("#", "").trim();
    if (/^[0-9a-fA-F]{3}$/.test(hex)) {
      const r = parseInt(hex[0] + hex[0], 16);
      const g = parseInt(hex[1] + hex[1], 16);
      const b = parseInt(hex[2] + hex[2], 16);
      return `rgba(${r},${g},${b},${alpha})`;
    }
    if (/^[0-9a-fA-F]{6}$/.test(hex)) {
      const r = parseInt(hex.slice(0, 2), 16);
      const g = parseInt(hex.slice(2, 4), 16);
      const b = parseInt(hex.slice(4, 6), 16);
      return `rgba(${r},${g},${b},${alpha})`;
    }
    return color;
  }

  // ==========================================================
  // CONFIG
  // ==========================================================
  async function loadConfig() {
    const url = window.location.origin + "/config.json";
    console.log(" Chargement config depuis:", url);
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("Config introuvable: " + res.status);
    return await res.json();
  }

  // ==========================================================
  // RÈGLES D’AFFICHAGE
  // ==========================================================
  function matchAnyRegex(patterns, href) {
    try { return patterns.some(p => new RegExp(p).test(href)); }
    catch (e) { console.warn("Regex invalide:", e); return false; }
  }
  function shouldRenderByUrl(config) {
    const rules = config?.display?.rules;
    if (!rules || !Array.isArray(rules.patterns) || !rules.patterns.length) return true;
    const href = location.href;
    const isMatch = matchAnyRegex(rules.patterns, href);
    return rules.mode === "blocklist" ? !isMatch : isMatch;
  }

  // ==========================================================
  // ANIMATIONS
  // ==========================================================
  const activeAnimations = new WeakMap();
  function applyAnimation(node, type) {
    const prev = activeAnimations.get(node);
    if (prev && prev.cancel) try { prev.cancel(); } catch { }
    if (!type || type === "none") return;
    let a;
    if (type === "pulse")
      a = node.animate([{ transform: "scale(1)" }, { transform: "scale(1.06)" }, { transform: "scale(1)" }],
        { duration: 1200, iterations: Infinity, easing: "ease-in-out" });
    else if (type === "bounce")
      a = node.animate([{ transform: "translateY(0)" }, { transform: "translateY(-6px)" }, { transform: "translateY(0)" }],
        { duration: 900, iterations: Infinity, easing: "ease-in-out" });
    activeAnimations.set(node, a);
  }

  // ==========================================================
  // BULLE
  // ==========================================================
  function clearOldBubbles() {
    document.querySelectorAll('[data-cb-root], .convertbubble-wrapper, .cb-overlay')
      .forEach(el => el.remove());
    document.getAnimations().forEach(a => { try { a.cancel(); } catch { } });
  }

  function createBubble(config) {
    clearOldBubbles();

    const theme = config.theme || {};
    const bubbleTheme = theme.bubble || {};
    const captionCfg = theme.caption || {};
    const shape = theme.shape || "circle";
    const pos = config.position || "BR";
    const anim = config.animation || "none";
    const bw = Math.max(bubbleTheme.width || 120, 120);
    const bh = bubbleTheme.height || 120;
    const captionPos = captionCfg.position || "right";
    const maxFraction = captionCfg.maxFraction || 0.5;

    const wrapper = el("div", {
      position: "fixed",
      zIndex: 2147483646,
      display: "flex",
      alignItems: "center",
      justifyContent: "center",
      cursor: "pointer",
      userSelect: "none",
      background: theme.primary || "#ff0055",
      color: captionCfg.color || "#fff",
      border: (theme.border?.width || 0) + "px solid " + (theme.border?.color || "transparent"),
      borderRadius: shape === "circle" ? "50%" : "14px",
      boxShadow: "0 10px 20px rgba(0,0,0,.18)",
      overflow: "hidden"
    });
    wrapper.classList.add("convertbubble-wrapper");
    wrapper.setAttribute("data-cb-root", "1");

    if (captionPos === "left" || captionPos === "right") {
      wrapper.style.width = px(bw + bw * maxFraction);
      wrapper.style.height = px(bh);
      wrapper.style.flexDirection = captionPos === "left" ? "row-reverse" : "row";
    } else {
      wrapper.style.width = px(bw);
      wrapper.style.height = px(bh + bh * maxFraction);
      wrapper.style.flexDirection = captionPos === "top" ? "column-reverse" : "column";
    }

    const bubbleContent = el("div", {
      width: px(bw),
      height: px(bh),
      display: "flex",
      alignItems: "center",
      justifyContent: "center",
      flexShrink: "0",
      overflow: "hidden"
    });

    const lc = config.launcherContent || { type: "emoji", emoji: " " };
    if (lc.type === "videoPreview") {
      const pv = el("video", { width: "100%", height: "100%", objectFit: "cover" });
      pv.src = lc.src || "";
      pv.muted = true; pv.autoplay = true; pv.playsInline = true; pv.loop = false;
      bubbleContent.appendChild(pv);
      const limit = lc.previewSeconds || 3;
      pv.addEventListener("timeupdate", () => { if (pv.currentTime >= limit) { pv.currentTime = 0; pv.play().catch(() => { }); } });
    } else if (lc.type === "image") {
      const img = el("img", { width: "100%", height: "100%", objectFit: "cover" });
      img.src = lc.src || "";
      bubbleContent.appendChild(img);
    } else {
      const icon = el("div", { fontSize: "34px" });
      icon.textContent = lc.emoji || " ";
      bubbleContent.appendChild(icon);
    }
    wrapper.appendChild(bubbleContent);

    if (captionCfg.text) {
      const caption = el("div", {
        flex: "1",
        padding: "4px 6px",
        fontSize: (captionCfg.fontSize || 13) + "px",
        textAlign: "center",
        color: captionCfg.color || "#fff"
      });
      caption.textContent = captionCfg.text;
      wrapper.appendChild(caption);
    }

    const margin = 18;
    if (pos.includes("B")) wrapper.style.bottom = px(margin);
    if (pos.includes("T")) wrapper.style.top = px(margin);
    if (pos.includes("R")) wrapper.style.right = px(margin);
    if (pos.includes("L")) wrapper.style.left = px(margin);

    applyAnimation(wrapper, anim);
    return wrapper;
  }

  // ==========================================================
  // OVERLAY VIDÉO
  // ==========================================================
  function openOverlay(config, wrapper) {
    document.querySelectorAll(".cb-overlay").forEach(o => o.remove());
    wrapper.style.display = "none";

    const overlay = el("div", {
      position: "fixed",
      inset: "0",
      background: `rgba(0,0,0,${config.theme?.overlayOpacity ?? 0.8})`,
      display: "flex",
      justifyContent: "center",
      alignItems: "center",
      zIndex: 10000
    });
    overlay.classList.add("cb-overlay");

    const box = el("div", {
      background: "rgba(11,16,32,0.8)",
      backdropFilter: "blur(12px)",
      borderRadius: "16px",
      padding: "16px",
      maxWidth: "90%",
      maxHeight: "90%",
      display: "flex",
      flexDirection: "column",
      color: "white",
      boxShadow: "0 0 40px rgba(0,0,0,0.6)"
    });

    const vcfg = config.video || {};
    const video = document.createElement("video");
    Object.assign(video.style, {
      width: "100%",
      height: "auto",
      borderRadius: "10px",
      objectFit: "contain",
      background: "#000"
    });
    video.src = vcfg.src || "";
    video.controls = true;
    video.autoplay = true;
    video.playsInline = true;
    box.appendChild(video);

    const closeBtn = el("button", {
      position: "absolute",
      top: "12px",
      right: "12px",
      border: "none",
      background: "rgba(255,255,255,0.25)",
      color: "#fff",
      fontSize: "22px",
      borderRadius: "50%",
      width: "36px",
      height: "36px",
      cursor: "pointer"
    });
    closeBtn.textContent = "×";
    closeBtn.onclick = () => { overlay.remove(); wrapper.style.display = "flex"; };
    box.appendChild(closeBtn);

    overlay.appendChild(box);
    document.body.appendChild(overlay);
  }

  // ==========================================================
  // INITIALISATION AUTOMATIQUE
  // ==========================================================
  (async function init() {
    try {
      clearOldBubbles();
      const config = await loadConfig();
      if (!shouldRenderByUrl(config)) return;
      const wrapper = createBubble(config);
      wrapper.onclick = () => openOverlay(config, wrapper);
      document.body.appendChild(wrapper);
    } catch (e) {
      console.error(" Erreur init ConvertBubble:", e);
    }
  })();

  // exporte les fonctions internes
  window.__cb_internal_createBubble = createBubble;
  window.__cb_internal_openOverlay = openOverlay;

})(); // FIN DU IIFE


// ==========================================================
// EXPORT GLOBAL POUR BUILDER
// ==========================================================
let __cb_createBubble, __cb_openOverlay;

document.addEventListener("DOMContentLoaded", () => {
  __cb_createBubble = window.__cb_internal_createBubble;
  __cb_openOverlay = window.__cb_internal_openOverlay;
});

window.ConvertBubble = {
  reload: async (newConfig) => {
    try {
      console.log(" Rechargement ConvertBubble avec nouvelle config...");
      document.querySelectorAll('[data-cb-root], .convertbubble-wrapper, .cb-overlay').forEach(e => e.remove());

      const config = newConfig || await (async () => {
        const url = window.location.origin + "/config.json";
        const res = await fetch(url, { cache: "no-store" });
        return await res.json();
      })();

      if (typeof __cb_createBubble !== "function") {
        console.warn(" createBubble non encore chargé, on réessaie...");
        return;
      }

      const wrapper = __cb_createBubble(config);
      wrapper.onclick = () => __cb_openOverlay(config, wrapper);
      document.body.appendChild(wrapper);

      console.log(" ConvertBubble rechargé avec succès");
    } catch (e) {
      console.error(" Erreur reload ConvertBubble:", e);
    }
  }
};

console.log(" ConvertBubble exporté globalement -> window.ConvertBubble OK");
