(function(){
  console.log("âœ… cb.js initialisÃ© (overlay CTA actif)");

  // ==== UTILITAIRES ====
  function el(tag,style){const e=document.createElement(tag);if(style)Object.assign(e.style,style);return e;}
  function px(n){return typeof n==="number"?n+"px":n;}
  function toRgba(color,alpha=1){alpha=Math.max(0,Math.min(1,alpha));
    if(!color)return`rgba(255,0,85,${alpha})`;
    const hex=color.replace("#","").trim();
    if(/^([0-9a-f]{3}){1,2}$/i.test(hex)){
      const full=hex.length===3?hex.split("").map(x=>x+x).join(""):hex;
      const r=parseInt(full.substr(0,2),16),g=parseInt(full.substr(2,2),16),b=parseInt(full.substr(4,2),16);
      return`rgba(${r},${g},${b},${alpha})`;
    }
    if(color.startsWith("rgb")) return color.replace(")",`,${alpha})`).replace("rgb","rgba");
    return color;
  }

  async function loadConfig(){
    const url=(document.currentScript&&document.currentScript.dataset.config)||"config.json";
    const res=await fetch(url,{cache:"no-store"});
    if(!res.ok)throw new Error("Config introuvable: "+res.status);
    return await res.json();
  }

  // ==== NETTOYAGE GLOBAL ====
  function clearAll(){
    document.querySelectorAll('[data-cb-root]').forEach(el=>el.remove());
    document.querySelectorAll('.cb-overlay').forEach(el=>el.remove());
    document.getAnimations().forEach(a=>{ try{a.cancel();}catch{} });
  }

  // ==== ANIMATION UNIQUE PAR Ã‰LÃ‰MENT ====
  const activeAnim = new WeakMap();
  function applyAnimation(node,type){
    const prev = activeAnim.get(node);
    if(prev && prev.cancel) try{prev.cancel();}catch{}
    if(!type || type==="none"){ activeAnim.delete(node); return; }

    let a;
    if(type==="pulse")
      a=node.animate([{transform:"scale(1)"},{transform:"scale(1.06)"},{transform:"scale(1)"}],
                     {duration:1200,iterations:Infinity,easing:"ease-in-out"});
    else if(type==="bounce")
      a=node.animate([{transform:"translateY(0)"},{transform:"translateY(-6px)"},{transform:"translateY(0)"}],
                     {duration:900,iterations:Infinity,easing:"ease-in-out"});
    activeAnim.set(node,a);
  }

  // ==== CRÃ‰ATION DE LA BULLE ====
  function createBubble(config){
    clearAll(); // ðŸ”¥ efface tout avant de recrÃ©er

    const theme=config.theme||{}, bubble=theme.bubble||{}, cap=theme.caption||{};
    const shape=theme.shape||"circle", pos=config.position||"BR", anim=config.animation||"none";
    const bw=Math.max(bubble.width||120,120), bh=bubble.height||120, maxF=cap.maxFraction||0.5;

    const w=el("div",{position:"fixed",zIndex:2147483646,display:"flex",alignItems:"center",justifyContent:"center",
      cursor:"pointer",userSelect:"none",background:theme.primary||"#ff0055",color:cap.color||"#fff",
      border:(theme.border?.width||0)+"px solid "+(theme.border?.color||"transparent"),
      borderRadius:shape==="circle"?"50%":"14px",boxShadow:"0 10px 20px rgba(0,0,0,.18)",overflow:"hidden"});
    w.setAttribute("data-cb-root","1");

    if(cap.position==="left"||cap.position==="right"){
      w.style.width=px(bw+bw*maxF);w.style.height=px(bh);
      w.style.flexDirection=cap.position==="left"?"row-reverse":"row";
    }else{
      w.style.width=px(bw);w.style.height=px(bh+bh*maxF);
      w.style.flexDirection=cap.position==="top"?"column-reverse":"column";
    }

    const content=el("div",{width:px(bw),height:px(bh),display:"flex",alignItems:"center",justifyContent:"center"});
    const lc=config.launcherContent||{type:"emoji",emoji:"â–¶"};
    if(lc.type==="image"){const img=el("img",{width:"100%",height:"100%",objectFit:"cover"});img.src=lc.src||"";content.appendChild(img);}
    else if(lc.type==="videoPreview"){const v=el("video",{width:"100%",height:"100%",objectFit:"cover"});v.src=lc.src||"";v.muted=!0;v.autoplay=!0;v.playsInline=!0;v.loop=!1;content.appendChild(v);}
    else{const icon=el("div",{fontSize:"34px"});icon.textContent=lc.emoji||"â–¶";content.appendChild(icon);}
    w.appendChild(content);

    if(cap.text){const c=el("div",{flex:"1",padding:"4px 6px",fontSize:(cap.fontSize||13)+"px",textAlign:"center",color:cap.color||"#fff"});c.textContent=cap.text;w.appendChild(c);}
    const m=18;if(pos.includes("B"))w.style.bottom=px(m);if(pos.includes("T"))w.style.top=px(m);
    if(pos.includes("R"))w.style.right=px(m);if(pos.includes("L"))w.style.left=px(m);

    applyAnimation(w,anim);
    return w;
  }

  // ==== OVERLAY ====
  function openOverlay(config,wrapper){
    document.querySelectorAll(".cb-overlay").forEach(o=>o.remove());

    wrapper.style.display="none";
    const ov=el("div",{position:"fixed",inset:"0",background:`rgba(0,0,0,${config.theme?.overlayOpacity ?? 0.9})`,
      display:"flex",justifyContent:"center",alignItems:"center",zIndex:10000});
    ov.classList.add("cb-overlay");

    const box=el("div",{background:"#0b1020",borderRadius:"12px",padding:"16px",maxWidth:"90%",maxHeight:"90%",
      position:"relative",display:"flex",flexDirection:"column",color:"white",boxShadow:"0 12px 40px rgba(0,0,0,0.5)"});
    if(config.branding?.enabled){
      const h=el("div",{background:config.branding.color||"#ff0055",padding:"10px",borderRadius:"8px",marginBottom:"8px",textAlign:"center"});
      h.textContent=config.branding.label||"";box.appendChild(h);
    }
    const v=el("video",{width:"100%",controls:!0,autoplay:!0,playsInline:!0,src:config.video?.src||"",background:"#000",borderRadius:"10px"});
    box.appendChild(v);ov.appendChild(box);document.body.appendChild(ov);
    v.play().catch(()=>{});
  }

  // ==== MOUNT AUTO ====
  window.createBubble=createBubble;
  window.openOverlay=openOverlay;

  // ðŸ§© Ã‰COUTEUR POUR COMMANDES DU BUILDER
  window.addEventListener('message', (e) => {
    if (!e.data || !e.data.type) return;
    if (e.data.type === 'cb:clear') {
      clearAll();
    }
  });

  (async function init(){
    try{
      const config=await loadConfig();
      const wrapper=createBubble(config);
      wrapper.onclick=()=>openOverlay(config,wrapper);
      document.body.appendChild(wrapper);
    }catch(e){console.error("âŒ Erreur init ConvertBubble:",e);}
  })();
})();

// ==== MODE PREVIEW STABLE ====
;(() => {
  try{ if(!/preview\.html$/.test(location.pathname)) return; }catch{return;}

  console.log("ðŸ§© Mode Preview actif â€“ ConvertBubble.mount disponible");

  async function initBubble(config,target=document.body){
    try{
      const w=window.createBubble(config);
      w.onclick=()=>window.openOverlay(config,w);
      target.appendChild(w);
      return { destroy(){ w.remove(); clearAll(); } };
    }catch(e){console.error("Erreur initBubble:",e);}
  }

  function clearAll(){
    document.querySelectorAll("[data-cb-root]").forEach(e=>e.remove());
    document.querySelectorAll(".cb-overlay").forEach(e=>e.remove());
    document.getAnimations().forEach(a=>{try{a.cancel();}catch{}});
  }

  window.ConvertBubble = (() => {
    let instance=null;
    function mount(cfg,{target=document.body}={}){ unmount(); instance=initBubble(cfg,target); return instance; }
    function unmount(){ clearAll(); if(instance&&instance.destroy)instance.destroy(); instance=null; }
    function reload(cfg){ unmount(); mount(cfg); }
    return { mount, unmount, reload };
  })();
})();

